// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  phone         String?
  password      String
  role          Role      @default(CUSTOMER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  bookings      Booking[]
  contracts     Contract[]
  payments      Payment[]
  
  @@map("users")
}

model Service {
  id          String  @id @default(cuid())
  name        String
  description String
  tier        ServiceTier
  category    String
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Pricing for different vehicle types
  prices      ServicePrice[]
  
  // Duration range in minutes
  durationMin Int
  durationMax Int
  
  bookingServices BookingService[]
  contractServices ContractService[]
  
  @@map("services")
}

model ServicePrice {
  id         String @id @default(cuid())
  serviceId  String
  vehicleType VehicleType
  priceMin    Float
  priceMax    Float
  
  service    Service @relation(fields: [serviceId], references: [id])
  
  @@unique([serviceId, vehicleType])
  @@map("service_prices")
}

model Booking {
  id            String    @id @default(cuid())
  userId        String
  date          DateTime
  time          String
  endTime       String?   // Calculated based on service duration
  location      String
  status        BookingStatus @default(PENDING)
  basePrice     Float     // Price before service charges
  serviceCharge Float     @default(0) // Distance-based service charge
  totalPrice    Float     // Final price including service charges
  notes         String?
  vehicleType   VehicleType
  numberOfCars  Int       @default(1)
  
  // Location data for distance calculation
  distance      Float?    // Distance from base location in km
  withinRadius  Boolean?  // Whether within 20km service radius
  
  // Invoice system fields
  invoiceNumber String?   @unique
  invoiceSentAt DateTime?
  invoiceExpiresAt DateTime?
  paymentStatus  InvoicePaymentStatus @default(PENDING)
  paymentMethod  String?   // "EFT", "Cash", "Bank Deposit"
  paidAt         DateTime?
  paidAmount     Float?
  adminNotes     String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id])
  services      BookingService[]
  payments      Payment[]
  
  @@map("bookings")
}

model Contract {
  id              String    @id @default(cuid())
  userId          String
  contractType    String
  totalWashes     Int
  usedWashes      Int       @default(0)
  remainingWashes Int
  totalPrice      Float
  startDate       DateTime
  endDate         DateTime
  status          ContractStatus @default(ACTIVE)
  contractUrl     String?
  signatureUrl    String?
  
  // Invoice system fields
  invoiceNumber   String?   @unique
  invoiceSentAt   DateTime?
  invoiceExpiresAt DateTime?
  paymentStatus   InvoicePaymentStatus @default(PENDING)
  paymentMethod   String?   // "EFT", "Cash", "Bank Deposit"
  paidAt          DateTime?
  paidAmount      Float?
  adminNotes      String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User      @relation(fields: [userId], references: [id])
  services        ContractService[]
  payments        Payment[]
  
  @@map("contracts")
}

model ContractService {
  id         String @id @default(cuid())
  contractId String
  serviceId  String
  
  contract   Contract @relation(fields: [contractId], references: [id])
  service    Service  @relation(fields: [serviceId], references: [id])
  
  @@unique([contractId, serviceId])
  @@map("contract_services")
}

model BookingService {
  id         String @id @default(cuid())
  bookingId  String
  serviceId  String
  price      Float  // Price at time of booking
  duration   Int    // Duration in minutes at time of booking
  
  booking    Booking @relation(fields: [bookingId], references: [id])
  service    Service @relation(fields: [serviceId], references: [id])
  
  @@unique([bookingId, serviceId])
  @@map("booking_services")
}

model Payment {
  id            String      @id @default(cuid())
  userId        String
  bookingId     String?
  contractId    String?
  amount        Float
  currency      String      @default("ZAR")
  status        PaymentStatus @default(PENDING)
  paymentMethod String
  transactionId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id])
  booking       Booking?    @relation(fields: [bookingId], references: [id])
  contract      Contract?   @relation(fields: [contractId], references: [id])
  
  @@map("payments")
}

model BlogPost {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String
  excerpt     String?
  coverImage  String?
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("blog_posts")
}

enum Role {
  CUSTOMER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ContractStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum InvoicePaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum ServiceTier {
  BASIC
  STANDARD
  PREMIUM
}

enum VehicleType {
  SMALL    // Small cars, hatchbacks, sedans
  SUV      // SUVs, bakkies, trucks
}
